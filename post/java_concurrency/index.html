<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>并发 - ticks blog</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="ticks" /><meta name="description" content="将任务移到实现了 Runable 接口类的 run 方法中 由 Runable 创建一个 Thread 对象 启动线程 线程 一个程序同时执行多个任务, 每个任务叫一个线程. #begin_example 一般来说, 进程(proces" />






<meta name="generator" content="Hugo 0.80.0 with theme even" />


<link rel="canonical" href="https://tickscn.github.io/post/java_concurrency/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.c7bc1becf36bcf6a9ebd25d2947e43a2eb745ddb0c9a32b43126fd7fa460c351.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="并发" />
<meta property="og:description" content="将任务移到实现了 Runable 接口类的 run 方法中 由 Runable 创建一个 Thread 对象 启动线程 线程 一个程序同时执行多个任务, 每个任务叫一个线程. #begin_example 一般来说, 进程(proces" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://tickscn.github.io/post/java_concurrency/" />
<meta property="article:published_time" content="2020-04-15T21:41:00+08:00" />
<meta property="article:modified_time" content="2020-04-15T21:41:00+08:00" />
<meta itemprop="name" content="并发">
<meta itemprop="description" content="将任务移到实现了 Runable 接口类的 run 方法中 由 Runable 创建一个 Thread 对象 启动线程 线程 一个程序同时执行多个任务, 每个任务叫一个线程. #begin_example 一般来说, 进程(proces">
<meta itemprop="datePublished" content="2020-04-15T21:41:00+08:00" />
<meta itemprop="dateModified" content="2020-04-15T21:41:00+08:00" />
<meta itemprop="wordCount" content="2780">



<meta itemprop="keywords" content="concurrency," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="并发"/>
<meta name="twitter:description" content="将任务移到实现了 Runable 接口类的 run 方法中 由 Runable 创建一个 Thread 对象 启动线程 线程 一个程序同时执行多个任务, 每个任务叫一个线程. #begin_example 一般来说, 进程(proces"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">ticks blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">主页</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">归档</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">标签</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">分类</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">ticks blog</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">主页</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">归档</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">标签</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">分类</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">并发</h1>

      <div class="post-meta">
        <span class="post-time"> 2020-04-15 </span>
        <div class="post-category">
            <a href="/categories/java/"> java </a>
            </div>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#线程">线程</a></li>
        <li><a href="#中断线程">中断线程</a></li>
        <li><a href="#线程状态">线程状态</a>
          <ul>
            <li><a href="#新创建">新创建</a></li>
            <li><a href="#可运行">可运行</a></li>
            <li><a href="#被阻塞和等待">被阻塞和等待</a></li>
            <li><a href="#被终止">被终止</a></li>
          </ul>
        </li>
        <li><a href="#线程属性">线程属性</a>
          <ul>
            <li><a href="#线程优先级">线程优先级</a></li>
            <li><a href="#守护线程">守护线程</a></li>
            <li><a href="#未捕获异常处理器">未捕获异常处理器</a></li>
          </ul>
        </li>
        <li><a href="#同步">同步</a>
          <ul>
            <li><a href="#锁对象">锁对象</a></li>
            <li><a href="#条件对象">条件对象</a></li>
            <li><a href="#synchronized-关键字"><code>synchronized</code> 关键字</a></li>
            <li><a href="#同步阻塞">同步阻塞</a></li>
            <li><a href="#监视器">监视器</a></li>
            <li><a href="#volatile"><code>Volatile</code></a></li>
            <li><a href="#final"><code>final</code></a></li>
            <li><a href="#原子性">原子性</a></li>
            <li><a href="#死锁">死锁</a></li>
            <li><a href="#线程局部变量">线程局部变量</a></li>
            <li><a href="#锁测试与超时">锁测试与超时</a></li>
            <li><a href="#读写锁">读写锁</a></li>
          </ul>
        </li>
        <li><a href="#阻塞队列">阻塞队列</a></li>
        <li><a href="#线程安全的集合">线程安全的集合</a>
          <ul>
            <li><a href="#集-映射-队列">集、映射、队列</a></li>
          </ul>
        </li>
        <li><a href="#callable-和-future">Callable 和 Future</a></li>
        <li><a href="#执行器">执行器</a>
          <ul>
            <li><a href="#线程池">线程池</a></li>
            <li><a href="#预定执行">预定执行</a></li>
            <li><a href="#fork-join-框架">Fork-Join 框架</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <ol>
<li>将任务移到实现了 Runable 接口类的 run 方法中</li>
<li>由 Runable 创建一个 Thread 对象</li>
<li>启动线程</li>
</ol>
<h2 id="线程">线程</h2>
<p>一个程序同时执行多个任务, 每个任务叫一个线程.
#begin_example
一般来说, 进程(process)有自己独立的变量, 而线程(thread)则共享代码、数据、文件.
#end_example
一个数据求和的例子</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Summation</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="na">length</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">args</span><span class="o">[</span><span class="n">0</span><span class="o">])</span> <span class="o">&lt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">args</span><span class="o">[</span><span class="n">0</span><span class="o">]</span> <span class="o">+</span> <span class="s">&#34; is &lt; 0, the integer must be &gt;= 0&#34;</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="kt">int</span> <span class="n">upper</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">args</span><span class="o">[</span><span class="n">0</span><span class="o">]);</span>
                <span class="n">Thread</span> <span class="n">thread</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
                    <span class="kt">int</span> <span class="n">sum</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
                    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">upper</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                        <span class="n">sum</span> <span class="o">+=</span> <span class="n">i</span><span class="o">;</span>
                    <span class="o">}</span>
                    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;sum from 0 to &#34;</span> <span class="o">+</span> <span class="n">upper</span> <span class="o">+</span> <span class="s">&#34; is &#34;</span> <span class="o">+</span> <span class="n">sum</span><span class="o">);</span>
                <span class="o">});</span>
                <span class="n">thread</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">else</span>
            <span class="n">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;&lt;Usage&gt;: java Summation &lt;Integer&gt;&#34;</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="中断线程">中断线程</h2>
<p>可以用 interrupt 方法来中断线程</p>
<ul>
<li>void interrupt() 发送中断请求, 中断状态被设为 true. 如果调用时线程被阻塞, 抛出 InterruptExpection 异常</li>
<li>static boolean interrupted() 判断是否中断, 并将中断状态设为 false</li>
<li>boolean isInterrupted() 判断是不中断, 不改变中断状态</li>
</ul>
<h2 id="线程状态">线程状态</h2>
<ul>
<li>New (新创建)</li>
<li>Runable (可运行) Ready(准备好)</li>
<li>Bolcked (被阻塞)</li>
<li>Waitting (等待)</li>
<li>Timed waitting (计时等待)</li>
<li>Terminated (被终止)</li>
</ul>
<p>可调用 getState() 获取线程状态</p>
<h3 id="新创建">新创建</h3>
<p>当用 new 操作符创建一个线程时, 线程还没可时运行</p>
<h3 id="可运行">可运行</h3>
<p>调用 start 方法, 线程处于 Runable 状态. 处于此状态的线程可能在运行, 也可能没在运行. 取决于操作系统提供的运行时间</p>
<h3 id="被阻塞和等待">被阻塞和等待</h3>
<p>当线程处于被阻塞或等待状态时, 线程暂时不活动. 直到线程调度器重新激活它</p>
<ul>
<li>当一个线程试图获取内部的锁, 而且该锁被其它线程持有, 本线程进入阻塞状态. 当锁被释放且调度器允许本线程持有它, 本线程进入非阻塞状态</li>
<li>当一个线程等待另一个线程通知线程调度器一个条件时, 进入等待</li>
<li>带有超时参数的方法会导致线程进入计时等待</li>
</ul>
<h3 id="被终止">被终止</h3>
<ul>
<li>run 运行完毕, 自然死亡</li>
<li>出现未捕获的异常, 意外死亡</li>
</ul>
<h2 id="线程属性">线程属性</h2>
<h3 id="线程优先级">线程优先级</h3>
<p>默认情况下, 一个线程继承其父线程的优先级. 可以用 setPriority 方法设置优先级 MIN_PRIORITY (设为 1), MAX_PRIORITY(设为 10), NORM_PROORITY(设为 5)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-text" data-lang="text">线程优先级的实现非常依赖宿主机平台的线程实现. 不要过于依赖优先级来保证运行正确
</code></pre></td></tr></table>
</div>
</div><h3 id="守护线程">守护线程</h3>
<p>调用 t.setDaemon(true) 可以把线程 t 设为守护线程. 守护线程为其它线程提供服务. 只剩下守护线程时, 程序退出</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-text" data-lang="text">守护进程不应该访问固有资源
</code></pre></td></tr></table>
</div>
</div><h3 id="未捕获异常处理器">未捕获异常处理器</h3>
<p>实现了 Thread.UncaughtExpectionHandler 接口的类, 该接口只有一个方法
void uncaughtExpection(Thread t, Throwable e)
使用 setUncaughtExpectionHandler 为线程安装处理器</p>
<h2 id="同步">同步</h2>
<p>双线程同时修改一个对象, 有可能发生竞争</p>
<h3 id="锁对象">锁对象</h3>
<p>synchronized 关键字自动添加锁和条件.
并且 Java SE 5.0 引入 ReentrantLock 类. 模版</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="n">mylock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
<span class="k">try</span><span class="o">{</span>
    <span class="o">...</span>
<span class="o">}</span>
<span class="k">finally</span><span class="o">{</span>
    <span class="n">mylock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>void lock() 获取锁, 如果以被另一个线程拥有. 进入阻塞</li>
<li>void unlock() 释放锁</li>
<li>ReentrantLock() 构建一个可重入锁</li>
<li>ReentrantLock(boolean fair) 构建一个公平策略的锁</li>
</ul>
<h3 id="条件对象">条件对象</h3>
<p>有时进入临界区后发现需要获得一个条件才能执行. 当本线程不满足某个条件时需要其它线程对其操作. 而本线程又被加锁, 需要条件对象.
使用 ReentrantLock 的 newCondition 方法, 添加一个条件. 当发现不满足条件时, 调用 await 方法使当前线程处于阻塞状态并进入该条件的等待集. 与普通等待锁的线程不同, 当锁可用时, 该线程仍然处于阻塞状态直到另一个线程调用同一个条件的 singalAll 方法.
singal()方法随机通知一个线程</p>
<h3 id="synchronized-关键字"><code>synchronized</code> 关键字</h3>
<p>从 1.0 版本开始, Java 每一个对象都有一个内部锁. 如果使用 <code>synchronized</code> 声明方法, 对象的锁将保护整个方法调用 wait 方法使当前线程处于阻塞状态并进入该条件的等待集. notifyALl/notify 能知线程</p>
<h4 id="内部锁和条件的局限">内部锁和条件的局限</h4>
<ul>
<li>不能中断一个试图获得锁的线程</li>
<li>试图获得锁时不能设定超时</li>
<li>每个锁仅有单一个条件</li>
</ul>
<h3 id="同步阻塞">同步阻塞</h3>
<p>可以使用进入同步阻塞的方法获得锁. 可以截获对象的锁</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">transfer</span><span class="o">(</span><span class="n">Vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="n">accounts</span><span class="o">,</span> <span class="kt">int</span> <span class="n">from</span><span class="o">,</span> <span class="kt">int</span> <span class="n">to</span> <span class="o">,</span> <span class="kt">double</span> <span class="n">amount</span><span class="o">)</span>
<span class="o">{</span>
    <span class="kd">synchronized</span><span class="o">(</span><span class="n">accounts</span><span class="o">)</span>
    <span class="o">{</span>
        <span class="n">accounts</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">from</span><span class="o">,</span> <span class="n">accounts</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">from</span><span class="o">)</span> <span class="o">-</span> <span class="n">amount</span><span class="o">);</span>
        <span class="n">accounts</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">to</span><span class="o">,</span> <span class="n">accounts</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">to</span><span class="o">)</span> <span class="o">+</span> <span class="n">amount</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Vector 的文档并没有承诺修改方法都使用内部锁. 所以这种方法有些脆弱. 不推荐使用</p>
<h3 id="监视器">监视器</h3>
<p>面向对象的多线程</p>
<ul>
<li>监视器只包含私有域</li>
<li>每个监视器对象有一个相关锁</li>
<li>使用该锁对所有方法加锁</li>
<li>该锁可以有任意多个相关条件</li>
</ul>
<p>Java 对象再以与方面不同于监视器</p>
<ul>
<li>不要求只包含私有域</li>
<li>方法不要求必须是 synchronized</li>
<li>内部锁对客户是可用的</li>
</ul>
<h3 id="volatile"><code>Volatile</code></h3>
<p>如果一个域被声明为 volatile, 那么编译器和虚拟机就知道该域有可能被其它线程并发更新. 可以使域的同步访问免锁</p>
<h3 id="final"><code>final</code></h3>
<p>被声明为 final 的域也可以安全的访问</p>
<h3 id="原子性">原子性</h3>
<p>java.util.concurrent.atomic 包中有很多类使用了高效的机器指令来保证其操作的原子性</p>
<h4 id="atomicinteger">AtomicInteger</h4>
<p>AtomicInteger 类提供的</p>
<ul>
<li>incrementAndGet() 自增 1</li>
<li>decrementAndGet() 自减 1</li>
<li>compareAndSet 如果另一个线程也在更新对象, 就可能阻止该线程更新. compareAndSet 返回 false 可以使用循环保证成功更新</li>
</ul>
<!--listend-->
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="k">do</span><span class="o">{</span>
    <span class="n">oldValue</span> <span class="o">=</span> <span class="n">largest</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
    <span class="n">newValue</span> <span class="o">=</span> <span class="n">Maht</span><span class="o">.</span><span class="na">max</span><span class="o">(</span><span class="n">oldValue</span><span class="o">,</span> <span class="n">observed</span><span class="o">);</span>
<span class="o">}</span><span class="k">while</span><span class="o">(!</span><span class="n">largest</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="n">oldValue</span><span class="o">,</span> <span class="n">newValue</span><span class="o">));</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>Java SE 8 有了更简便的写法
<ul>
<li>largest.updateAndGet(x-&gt;Math.max(x, observed)</li>
<li>largest.accumulateAndGet(observed, Math::max)</li>
</ul>
</li>
</ul>
<h3 id="死锁">死锁</h3>
<p>所有线程都阻塞, 会导致无法唤醒</p>
<h3 id="线程局部变量">线程局部变量</h3>
<p>ThreadLocal 类生成每个线程个子的局部变量</p>
<h3 id="锁测试与超时">锁测试与超时</h3>
<p>调用 lock 获取锁时很可能发生阻塞.可以使用 tryLock() 如果成功返回 true, 否则立即返回 false, 还可以调用时加上超时参数</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">  <span class="k">if</span><span class="o">(</span><span class="n">myLock</span><span class="o">.</span><span class="na">tryLock</span><span class="o">(</span><span class="n">100</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">MILLISECONDS</span><span class="o">)){</span>
      <span class="k">try</span><span class="o">{</span>
          <span class="o">...</span>
      <span class="o">}</span> <span class="k">finally</span><span class="o">{</span>
          <span class="n">myLock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
      <span class="o">}</span>
  <span class="o">}</span>
<span class="k">else</span>
 <span class="o">...</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="读写锁">读写锁</h3>
<p>java.util.concurrent.locks 包含了两个锁类</p>
<ul>
<li>ReentrantLock</li>
<li>ReentrantReadWriteLock</li>
</ul>
<p>使用读写锁</p>
<ol>
<li>
<p>构造一个 ReentranReadWriteLock 对象
<code>private ReentrantReadWriteLock rwl = new ReentrantReadWriteLock()</code></p>
</li>
<li>
<p>抽取读锁和写锁</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">private Lock <span class="nv">readLock</span> <span class="o">=</span> rwl.readLock<span class="o">()</span><span class="p">;</span>
private Lock <span class="nv">writeLock</span> <span class="o">=</span> rwl.writeLock<span class="o">()</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>为获取方法加读锁</p>
</li>
<li>
<p>为设置方法加写锁</p>
</li>
</ol>
<h2 id="阻塞队列">阻塞队列</h2>
<p>生产者-阻塞队列-消费者当阻塞队列满时, 生产者线程若想向队列添加元素, 就会进入阻塞状态. 或着队列为空, 消费者队列想从队列移出元素时,进入阻塞.</p>
<p>阻塞队列的方法</p>
<table>
<thead>
<tr>
<th>方法</th>
<th>正常动作</th>
<th>特殊情况下的动作</th>
</tr>
</thead>
<tbody>
<tr>
<td>add</td>
<td>添加一个元素</td>
<td>队列已满, 抛出 IllegalStateException</td>
</tr>
<tr>
<td>element</td>
<td>返回头元素</td>
<td>队列己空, 抛出 NoSuchElementException</td>
</tr>
<tr>
<td>offer</td>
<td>添加元素并返回 true</td>
<td>队列己满, 返回 false</td>
</tr>
<tr>
<td>peek</td>
<td>返回头元素</td>
<td>队列己空, 返回 null</td>
</tr>
<tr>
<td>poll</td>
<td>移出并返回头元素</td>
<td>队列己空, 返回 null</td>
</tr>
<tr>
<td>put</td>
<td>添加一个元素</td>
<td>队列己满, 阻塞</td>
</tr>
<tr>
<td>remove</td>
<td>移出并返回头元素</td>
<td>队列己空, 抛出 NoSuchElementException</td>
</tr>
<tr>
<td>take</td>
<td>移出并返回头元素</td>
<td>队列己空, 阻塞</td>
</tr>
</tbody>
</table>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">import</span> <span class="nn">java.io.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.*</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">BlockingQueueTest</span><span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">FILE_QUEUE_SIZE</span> <span class="o">=</span> <span class="n">10</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">SEARCH_THREAD</span> <span class="o">=</span> <span class="n">100</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">File</span> <span class="n">DUMMY</span> <span class="o">=</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="s">&#34;&#34;</span><span class="o">);</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="n">BlockingQueue</span><span class="o">&lt;</span><span class="n">File</span><span class="o">&gt;</span> <span class="n">queue</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayBlockingQueue</span><span class="o">&lt;&gt;(</span><span class="n">FILE_QUEUE_SIZE</span><span class="o">);</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">enumerate</span><span class="o">(</span><span class="n">File</span> <span class="n">directory</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">InterruptedException</span><span class="o">{</span>
        <span class="n">File</span><span class="o">[]</span> <span class="n">files</span> <span class="o">=</span> <span class="n">directory</span><span class="o">.</span><span class="na">listFiles</span><span class="o">();</span>
        <span class="k">for</span><span class="o">(</span><span class="n">File</span> <span class="n">file</span><span class="o">:</span><span class="n">files</span><span class="o">){</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">file</span><span class="o">.</span><span class="na">isDirectory</span><span class="o">())</span>
                <span class="n">enumerate</span><span class="o">(</span><span class="n">file</span><span class="o">);</span>
            <span class="k">else</span>
                <span class="n">queue</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">file</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">search</span><span class="o">(</span><span class="n">File</span> <span class="n">file</span><span class="o">,</span> <span class="n">String</span> <span class="n">key</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">{</span>
        <span class="k">try</span><span class="o">(</span><span class="n">Scanner</span> <span class="n">in</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Scanner</span><span class="o">(</span><span class="n">file</span><span class="o">,</span> <span class="s">&#34;UTF-8&#34;</span><span class="o">)){</span>
            <span class="kt">int</span> <span class="n">lineNumber</span><span class="o">=</span><span class="n">0</span><span class="o">;</span>
            <span class="k">while</span><span class="o">(</span><span class="n">in</span><span class="o">.</span><span class="na">hasNextLine</span><span class="o">()){</span>
                <span class="n">lineNumber</span><span class="o">++;</span>
                <span class="n">String</span> <span class="n">line</span> <span class="o">=</span> <span class="n">in</span><span class="o">.</span><span class="na">nextLine</span><span class="o">();</span>
                <span class="k">if</span><span class="o">(</span><span class="n">line</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">key</span><span class="o">)){</span>
                    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">&#34;%s:%d:%s\n&#34;</span><span class="o">,</span> <span class="n">file</span><span class="o">.</span><span class="na">getPath</span><span class="o">(),</span> <span class="n">lineNumber</span><span class="o">,</span> <span class="n">line</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span><span class="n">args</span><span class="o">){</span>
        <span class="k">try</span><span class="o">(</span><span class="n">Scanner</span> <span class="n">in</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Scanner</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">in</span><span class="o">)){</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">&#34;Enter base director: &#34;</span><span class="o">);</span>
            <span class="n">String</span> <span class="n">directory</span> <span class="o">=</span> <span class="n">in</span><span class="o">.</span><span class="na">nextLine</span><span class="o">();</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">&#34;Enter keyword: &#34;</span><span class="o">);</span>
            <span class="n">String</span> <span class="n">key</span> <span class="o">=</span> <span class="n">in</span><span class="o">.</span><span class="na">nextLine</span><span class="o">();</span>

            <span class="n">Runnable</span> <span class="n">enumator</span> <span class="o">=</span> <span class="o">()-&gt;{</span>
                <span class="k">try</span><span class="o">{</span>
                    <span class="n">enumerate</span><span class="o">(</span><span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">directory</span><span class="o">));</span>
                    <span class="n">queue</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">DUMMY</span><span class="o">);</span>
                <span class="o">}</span><span class="k">catch</span><span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">){}</span>
            <span class="o">};</span>

            <span class="k">new</span> <span class="n">Thread</span><span class="o">(</span><span class="n">enumator</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>

            <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">SEARCH_THREAD</span><span class="o">;</span><span class="n">i</span><span class="o">++){</span>
                <span class="n">Runnable</span> <span class="n">searcher</span> <span class="o">=</span> <span class="o">()-&gt;{</span>
                    <span class="k">try</span><span class="o">{</span>
                        <span class="kt">boolean</span> <span class="n">done</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                        <span class="k">do</span><span class="o">{</span>
                            <span class="n">File</span> <span class="n">file</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="na">take</span><span class="o">();</span>
                            <span class="k">if</span><span class="o">(</span><span class="n">file</span> <span class="o">==</span> <span class="n">DUMMY</span><span class="o">){</span>
                                <span class="n">queue</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">file</span><span class="o">);</span>
                                <span class="n">done</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                            <span class="o">}</span>
                            <span class="k">else</span> <span class="n">search</span><span class="o">(</span><span class="n">file</span><span class="o">,</span> <span class="n">key</span><span class="o">);</span>
                        <span class="o">}</span><span class="k">while</span><span class="o">(!</span><span class="n">done</span><span class="o">);</span>
                    <span class="o">}</span><span class="k">catch</span><span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">){</span>
                        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                    <span class="o">}</span>
                    <span class="k">catch</span><span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">){}</span>
                <span class="o">};</span>
                <span class="k">new</span> <span class="n">Thread</span><span class="o">(</span><span class="n">searcher</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="线程安全的集合">线程安全的集合</h2>
<h3 id="集-映射-队列">集、映射、队列</h3>
<p>java.util.concurrent 包提供了映射、有序集、和队列的高效实现 ConcurrentHashMap, ConcurrentSkipListMap, ConcurrnetSkipListSet, ConcurrentLinkedQueue.</p>
<p>这些方法不要求 size 方法常量复杂度</p>
<h2 id="callable-和-future">Callable 和 Future</h2>
<p>Callable 与 Runnable 类似, 但是有返回值</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Callable</span><span class="o">&lt;</span><span class="n">V</span><span class="o">&gt;{</span>
    <span class="n">V</span> <span class="nf">call</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Future</span><span class="o">&lt;</span><span class="n">V</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="n">V</span> <span class="nf">get</span><span class="o">();</span>
    <span class="n">V</span> <span class="nf">get</span><span class="o">(</span><span class="kt">long</span> <span class="n">timeout</span><span class="o">,</span> <span class="n">TimeUnit</span> <span class="n">unit</span><span class="o">)</span> <span class="kd">throws</span> <span class="o">...;</span>
    <span class="kt">void</span> <span class="nf">cancel</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">myInterrupt</span><span class="o">);</span>
    <span class="kt">boolean</span> <span class="nf">isCanceled</span><span class="o">();</span>
    <span class="kt">boolean</span> <span class="nf">isDonw</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="执行器">执行器</h2>
<p>构建新的线程是有一定消耗的, 所以需要创建很多短线程时应该使用线程池. 将 Runnable 交给一个线程池就会有一个线程调用 run 方法. 当 run 方法退出时, 线程不会死亡而是重新进入线程池等待任务. 执行器 Executor 有很多工厂方法可以生成线程池</p>
<ul>
<li>newCachedThreadPool 必要时创建新线程, 空闲线程保留 60s</li>
<li>newFixedThreadPool 创建固定大小的线程池, 空闲线程永远保留</li>
<li>newSingleThreadExecutor 只有一个线程的池, 按顺序执行提交的任务</li>
<li>newScheduleThreadPool 预定执行的固定线程池</li>
<li>newSingleThreadScheduleExecutor</li>
</ul>
<h3 id="线程池">线程池</h3>
<p>实现了 ExecutorService 接口的类</p>
<ol>
<li>使用静态方法创建线程池</li>
<li>使用 submit 提交任务</li>
<li>如果想要取消一个任务, 或者提交的是 Callable<T> 需要保存好 submit 返回的 Future</li>
<li>当不在提交任务时, 调用 shutdown</li>
</ol>
<h3 id="预定执行">预定执行</h3>
<p>实现了 ScheduleExecutorService 接口的类, 可以进行预定执行或重复执行</p>
<ul>
<li>schedule(Callable<V> task, long time, TimeUnit unit) 预定在指定的时间之后执行任务</li>
<li>schedule(Runnable task, long time, TimeUnit unit) 预定在指定的时间之后执行任务</li>
<li>scheduleAtFixedRate(Runnable task, long initialDelay, long period, TimeUnit unit) 初始延迟后, 以周期 period 运行任务</li>
<li>scheduleWithFixedRate(Runnable task, long initialDelay, long delay, TimeUnit unit) 初始延迟后, 上次调用完成与下次调用开始之间有延迟 delay</li>
</ul>
<h3 id="fork-join-框架">Fork-Join 框架</h3>
<p>递归的子任务</p>
<ul>
<li>RecursiveTask<T> 返回 T 类型</li>
<li>RecursiveAbstract 不返回</li>
</ul>
<p>扩展上面两个类, 覆盖 compute 方法</p>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">ticks</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        2020-04-15
        
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">许可协议</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/concurrency/">concurrency</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/java_stream/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">流库</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/post/java_release/">
            <span class="next-text nav-default">部署 Java 应用程序</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        <div id="gitalk-container"></div>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js" crossorigin="anonymous"></script>
    <script type="text/javascript">
      var gitalk = new Gitalk({
        id: '2020-04-15 21:41:00 \u002b0800 CST',
        title: '并发',
        clientID: 'ea0e3eccad5c469abf15',
        clientSecret: 'f80a60df515da91e6c9b53c0bede3227ebe2f8ce',
        repo: 'tickscn.github.io',
        owner: 'tickscn',
        admin: ['tickscn'],
        body: decodeURI(location.href)
      });
      gitalk.render('gitalk-container');
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/gitalk/gitalk">comments powered by gitalk.</a></noscript>

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:xiehuiwu1996@gmail.com" class="iconfont icon-email" title="email"></a>
      <a href="https://github.com/tickscn/" class="iconfont icon-github" title="github"></a>
  <a href="https://tickscn.github.io/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2019 - 
    2021<span class="heart"><i class="iconfont icon-heart"></i></span><span>ticks</span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c12618f9a600c40bd024996677e951e64d3487006775aeb22e200c990006c5c7.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
